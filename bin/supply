#!/usr/bin/env bash
 
set -euo pipefail 

# https://docs.cloudfoundry.org/buildpacks/understand-buildpacks.html
BUILD_DIR="${1}"
CACHE_DIR="${2}"
DEPS_DIR="${3}"
DEPS_IDX="${4}"

BUILDPACK_DIR=$(dirname $(readlink -f ${BASH_SOURCE%/*}))
#source ${BUILDPACK_DIR}/parameters.sh

if [ -f "${CACHE_DIR}"/"quarto-1.5.53-linux-amd64.tar.gz" ]
then
    echo "-----> Using Quarto from cache"
else
    echo "-----> Downloading Quarto"
    #https://github.com/quarto-dev/quarto-cli/releases/download/v1.5.53/quarto-1.5.53-linux-amd64.deb 
    curl -fsSLO https://github.com/quarto-dev/quarto-cli/releases/download/v1.5.53/quarto-1.5.53-linux-amd64.tar.gz

    mv "quarto-1.5.53-linux-amd64.tar.gz" "${CACHE_DIR}/quarto-1.5.53-linux-amd64.tar.gz"

    # https://quarto.org/docs/download/tarball.html
    echo "-----> Extracting Quarto"
    # Extract files in to directory a quarto directory
    mkdir -p "${DEPS_DIR}/${DEPS_IDX}/quarto"
    tar -C "${DEPS_DIR}/${DEPS_IDX}/quarto" -xvzf "${CACHE_DIR}/quarto-1.5.53-linux-amd64.tar.gz"

    #cp "${CACHE_DIR}/quarto-1.5.53-linux-amd64.tar.gz" "${DEPS_DIR}/${DEPS_IDX}/quarto"
    chmod +x "${DEPS_DIR}/${DEPS_IDX}/quarto/quarto-1.5.53/bin/quarto"
    
fi